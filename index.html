<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>é¼»é¼»é¤Šæˆé—–é—œï½œWeek 1-2 é—–é—œåœ°åœ–ç‰ˆ</title>
  <style>
    /* ===== æ ¸å¿ƒè®Šæ•¸ ===== */
    :root{
      --bg1:#2b1b14; --bg2:#7a4b2b;
      --panel:#f4e2c8; --panel2:#f0d6b0;
      --ink:#1a1412; --muted:#5b4b42;
      --accent:#ffb23f; --accent2:#ff7a59;
      --good:#1b7f4b; --bad:#b45309;
      --round:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,"Microsoft JhengHei",sans-serif;
      color:var(--ink); min-height:100vh;
      background: radial-gradient(circle at 50% 10%, rgba(255,255,255,0.1), transparent), linear-gradient(155deg, var(--bg1), var(--bg2));
      overflow-x: hidden; padding-bottom: 40px;
    }
    .wrap{max-width:480px;margin:0 auto;padding:16px;} /* æ‰‹æ©Ÿç‰ˆå‹å„ªåŒ– */
    
    /* é ‚éƒ¨ */
    .topbar{display:flex;justify-content:space-between;align-items:center;color:#fff;margin-bottom:20px;padding:0 10px;}
    .brand{font-weight:900;font-size:20px;text-shadow:0 2px 4px rgba(0,0,0,0.2);}
    .btnTiny{background:rgba(0,0,0,.2);color:#fff;border:1px solid rgba(255,255,255,.2);padding:6px 12px;border-radius:20px;cursor:pointer;font-size:12px;backdrop-filter:blur(4px);}

    /* === ğŸ—ºï¸ é—–é—œåœ°åœ–æ¨£å¼ (Duolingo é¢¨æ ¼) === */
    .map-container {
      display: flex; flex-direction: column; align-items: center; gap: 40px; padding: 40px 0;
      position: relative;
    }
    /* é€£æ¥ç·š */
    .path-line {
      position: absolute; top: 60px; bottom: 60px; width: 8px; background: rgba(255,255,255,0.2);
      z-index: 0; border-radius: 4px;
    }
    
    /* é—œå¡çƒ */
    .level-node {
      width: 90px; height: 90px; border-radius: 50%;
      background: #fff; border-bottom: 6px solid #e0e0e0;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      position: relative; z-index: 2; cursor: pointer;
      transition: transform .1s;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .level-node:active { transform: translateY(4px); border-bottom-width: 2px; }
    
    /* ç‹€æ…‹é¡è‰² */
    .level-node.locked { filter: grayscale(1); opacity: 0.7; cursor: not-allowed; }
    .level-node.active { background: var(--accent); border-color: #e59400; animation: pulse 2s infinite; }
    .level-node.done { background: var(--good); border-color: #145e35; color: #fff; }
    .level-node.done::after { content:"ğŸ‘‘"; position:absolute; top:-15px; right:-10px; font-size:30px; animation: bounce 1s infinite; }

    .level-icon { font-size: 36px; margin-bottom: 4px; }
    .level-title { 
      position: absolute; bottom: -30px; width: 140px; text-align: center;
      font-weight: 900; color: #fff; font-size: 14px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      background: rgba(0,0,0,0.2); padding: 4px; border-radius: 10px;
    }

    /* çç›ƒæŒ‰éˆ• */
    .trophy-btn {
      width: 70px; height: 70px; border-radius: 50%; background: #fff;
      display: flex; align-items: center; justify-content: center; font-size: 30px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2); border: 4px solid var(--accent2);
      cursor: pointer; position: relative; z-index: 2; margin-top: 20px;
    }

    @keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(255,178,63,0.7)} 70%{box-shadow:0 0 0 15px rgba(255,178,63,0)} 100%{box-shadow:0 0 0 0 rgba(255,178,63,0)} }
    @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-5px)} }

    /* === éŠæˆ²å…§å®¹å®¹å™¨ (åŸæœ¬çš„ Card) === */
    .game-view {
      position: fixed; inset: 0; background: linear-gradient(180deg, var(--panel), var(--panel2));
      z-index: 100; overflow-y: auto; display: none; padding: 20px;
    }
    .game-view.show { display: block; animation: slideUp .3s; }
    @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }

    .nav-header { display: flex; align-items: center; margin-bottom: 20px; }
    .btn-back { background: none; border: none; font-size: 24px; cursor: pointer; margin-right: 15px; }
    .view-title { font-weight: 900; font-size: 18px; color: var(--ink); }

    /* ä»¥ä¸‹ä¿ç•™åŸæœ¬çš„éŠæˆ²æ¨£å¼ */
    .charStage{
      padding:14px; min-height:480px; margin-bottom: 15px;
      background: radial-gradient(circle at 50% 30%, rgba(255,255,255,0.8), rgba(255,255,255,0.2));
      display: flex; flex-direction: column; position: relative; border-radius: 18px;
    }
    .stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;}
    .statBox{background:rgba(255,255,255,.6);border-radius:12px;padding:8px;}
    .statName{font-size:11px;color:var(--muted);font-weight:900}
    .statVal{font-size:15px;font-weight:900;}
    .bar{height:6px;background:rgba(0,0,0,.1);border-radius:4px;margin-top:4px;overflow:hidden}
    .bar>div{height:100%;background:var(--accent2);transition:width .3s}

    .bibi-container { margin: auto; width: 180px; height: 180px; position: relative; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .bibi-emoji { font-size: 100px; filter: drop-shadow(0 8px 16px rgba(0,0,0,0.15)); transition: transform .1s; }
    .bibi-emoji:active { transform: scale(0.95); }
    .bibiMood { position: absolute; bottom: 0; right: 0; font-size: 32px; background: #fff; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

    .bubble { margin-top: auto; background: #fff; border: 2px solid var(--ink); border-radius: 18px; padding: 16px; position: relative; min-height: 110px; display: flex; flex-direction: column; justify-content: space-between; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    .bubble::after { content: ""; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); border-width: 0 10px 10px; border-style: solid; border-color: transparent transparent var(--ink); }
    .bubbleText { font-size: 15px; line-height: 1.5; font-weight: 500; white-space: pre-line; color: var(--ink); }
    .btnNext { align-self: flex-end; background: var(--ink); color: #fff; border: none; padding: 6px 14px; border-radius: 20px; font-size: 12px; cursor: pointer; margin-top: 8px; animation: bounce 1s infinite; }

    /* W1/W2/Leaderboard å…§å®¹æ¨£å¼ */
    .tinder-container { position: relative; width: 100%; height: 320px; margin: 10px auto; display: flex; align-items: center; justify-content: center; }
    .tinder-card { position: absolute; width: 260px; height: 320px; background: #fff; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; text-align: center; border: 1px solid rgba(0,0,0,0.05); transition: transform .4s, opacity .4s; z-index: 2; }
    .tinder-card.swipe-left { transform: translateX(-150%) rotate(-20deg); opacity: 0; }
    .tinder-card.swipe-right { transform: translateX(150%) rotate(20deg); opacity: 0; }
    .tc-icon { font-size: 64px; margin-bottom: 20px; }
    .tc-title { font-size: 20px; font-weight: 900; margin-bottom: 10px; }
    .tc-desc { font-size: 14px; color: var(--muted); line-height: 1.6; }
    .swipe-actions { display: flex; justify-content: center; gap: 30px; margin-top: 10px; }
    .btn-round { width: 60px; height: 60px; border-radius: 50%; border: 0; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.1); background: #fff; }
    .btn-no { color: var(--bad); border: 2px solid #eee; } .btn-yes { color: var(--good); border: 2px solid #eee; }

    .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 380px; overflow-y: auto; padding: 4px; }
    .action-card { background: #fff; border-radius: 12px; border: 2px solid transparent; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 15px; text-align: center; }
    .action-card.selected { border-color: var(--good); background-color: rgba(27, 127, 75, 0.05); }
    .action-emoji { font-size: 40px; margin-bottom: 8px; }
    .action-text { font-size: 13px; font-weight: bold; }

    .room-container { position: relative; width: 100%; height: 300px; border-radius: 16px; margin-top: 10px; border: 4px solid #fff; background-image: url('https://images.unsplash.com/photo-1540518614846-7eded433c457?q=80&w=800&auto=format&fit=crop'); background-size: cover; background-position: center; box-shadow: inset 0 0 40px rgba(0,0,0,.2); overflow: hidden; }
    .prop { position: absolute; cursor: pointer; transition: transform 0.2s, filter 0.2s; z-index: 10; display: flex; flex-direction: column; align-items: center; }
    .prop:hover { transform: scale(1.1); } .prop.found { filter: grayscale(1) opacity(0.5); transform: scale(0.9); }
    .ac-unit { top: 20px; left: 30px; width: 80px; height: 35px; background: rgba(255,255,255,0.95); border-radius: 6px; border: 1px solid #ddd; display: flex; align-items: flex-end; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .ac-vent { width: 80%; height: 4px; background: #333; margin-bottom: 6px; border-radius: 2px; }
    .dust-monster { bottom: 30%; left: 20%; width: 40px; height: 40px; background: rgba(85,85,85,0.8); border-radius: 50%; animation: float 3s infinite ease-in-out; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; }
    .bibi-room { bottom: 20px; right: 40px; font-size: 60px; text-shadow: 0 0 10px rgba(255,255,255,0.8); }

    .leader-list { width: 100%; display: flex; flex-direction: column; gap: 8px; }
    .leader-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-radius: 16px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .leader-item.me { border: 2px solid var(--accent); background: #fffdf5; }
    .rank-num { font-weight: 900; color: var(--muted); width: 30px; text-align: center; }
    .user-info { flex: 1; display: flex; align-items: center; gap: 10px; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .user-name { font-weight: 900; font-size: 14px; }
    .user-exp { font-weight: bold; color: var(--good); }
    .league-badge { text-align: center; margin-bottom: 15px; }

    .btn { background: var(--ink); color: #fff; width: 100%; padding: 14px; border-radius: 14px; border: 0; font-weight: 900; cursor: pointer; margin-top: 10px; }
    .btn-choice { background: #fff; width: 100%; padding: 12px; border-radius: 12px; border: 1px solid rgba(0,0,0,.1); margin-top: 8px; text-align: left; cursor: pointer; }
    
    .hidden { display: none !important; }
    .nick-input-area { display: flex; gap: 8px; margin-top: 10px; }
    .nick-input { flex: 1; padding: 8px 12px; border: 2px solid var(--accent); border-radius: 12px; font-size: 14px; outline: none; }
    .btn-confirm { background: var(--good); color: #fff; border: none; padding: 8px 14px; border-radius: 12px; font-weight: bold; cursor: pointer; }
    
    /* å½ˆçª— */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.6); z-index: 999; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: .3s; }
    .modal-overlay.show { opacity: 1; pointer-events: auto; }
    .modal-box { background: #fff; width: 90%; max-width: 380px; padding: 24px; border-radius: 24px; text-align: center; }
  </style>
</head>
<body>

<div class="wrap">
  <div class="topbar">
    <div class="brand">ğŸ‘ƒ é¼»é¼»å¤§å†’éšª</div>
    <div class="row">
      <button class="btnTiny" onclick="setNick()">ä¿®æ”¹æš±ç¨±</button>
      <button class="btnTiny" onclick="resetAll()">é‡ç½®</button>
    </div>
  </div>

  <div class="map-container" id="mapView">
    <div class="path-line"></div>

    <div class="level-node active" id="node-w1" onclick="openLevel('w1')">
      <div class="level-icon">ğŸ˜·</div>
      <div class="level-title">Week 1: è¦ºå¯Ÿ</div>
    </div>

    <div class="level-node locked" id="node-w2" onclick="openLevel('w2')">
      <div class="level-icon">ğŸ”</div>
      <div class="level-title">Week 2: ç·šç´¢</div>
    </div>

    <div class="level-node locked" onclick="alert('Week 3 æŒ‰æ‘©æŠ€èƒ½\næ•¬è«‹æœŸå¾…ï¼ğŸ’†')">
      <div class="level-icon">ğŸ’†</div>
      <div class="level-title">Week 3: å¯¦ä½œ</div>
    </div>

    <div class="trophy-btn" onclick="openLevel('leader')">
      ğŸ†
    </div>
  </div>

  <div class="game-view" id="gameView">
    <div class="nav-header">
      <button class="btn-back" onclick="closeLevel()">â¬…</button>
      <div class="view-title" id="viewTitle">é—œå¡æ¨™é¡Œ</div>
    </div>

    <div class="charStage" id="charArea">
      <div class="stats">
        <div class="statBox"><div class="statName">HP</div><div class="statVal" id="hpVal">60</div><div class="bar"><div id="hpBar" style="width:60%"></div></div></div>
        <div class="statBox"><div class="statName">LV</div><div class="statVal" id="lvVal">1</div><div class="bar"><div id="lvBar" style="width:0%"></div></div></div>
      </div>
      <div class="bibi-container" onclick="pokeBibi()">
         <div class="bibi-emoji" id="mainBibi">ğŸ¤§</div>
         <div class="bibiMood" id="mood">ğŸ‘‹</div>
      </div>
      <div class="bubble">
        <div>
           <div style="font-size:12px;color:var(--bg2);font-weight:900;margin-bottom:4px">ğŸ—¨ï¸ é¼»é¼»</div>
           <div class="bubbleText" id="bubbleText">......</div>
           <div id="nickInputArea" class="nick-input-area hidden">
              <input type="text" id="nickInput" class="nick-input" placeholder="è¼¸å…¥ä½ çš„æš±ç¨±...">
              <button class="btn-confirm" onclick="confirmNick()">ç¢ºèª</button>
           </div>
        </div>
        <button class="btnNext hidden" id="btnNext" onclick="nextStory()">ä¸‹ä¸€æ­¥ â–¶</button>
      </div>
    </div>

    <div id="content-w1" class="hidden">
        <div id="w1-game-ui">
           <div class="tinder-container" id="card-stage"></div>
           <div class="swipe-actions">
             <button class="btn-round btn-no" onclick="swipe('left')">âŒ</button>
             <button class="btn-round btn-yes" onclick="swipe('right')">â­•</button>
           </div>
        </div>
        <div class="hidden" id="w1-action-ui">
           <div style="font-weight:900;margin-bottom:6px;color:var(--accent2)">â­ ä»Šå¤©é¡˜æ„å…ˆå˜—è©¦çš„å°è¡Œå‹•ï¼Ÿ</div>
           <div class="action-grid" id="action-stage"></div>
           <button class="btn" style="background:linear-gradient(90deg, var(--good), #2ecc71);color:white;" onclick="submitActions()">æ±ºå®šå¥½äº†ï¼</button>
        </div>
        <div class="hidden" id="w1-done" style="text-align:center;padding:30px">
          <div style="font-size:50px;margin-bottom:10px">âœ¨</div>
          <div style="font-weight:900;color:var(--good)">Week 1 å®Œæˆï¼</div>
          <p style="font-size:13px;color:#888;line-height:1.6">ç²å¾— 20 EXPã€‚<br>è¬è¬ä½ è½æˆ‘èªªï¼Œä¹Ÿè§€å¯Ÿäº†è‡ªå·±ã€‚</p>
          <button class="btn" onclick="closeLevel()">å›åˆ°åœ°åœ–</button>
        </div>
    </div>

    <div id="content-w2" class="hidden">
        <div id="w2-content">
           <div class="room-container">
             <div class="ac-unit prop" id="prop-ac" onclick="findClue(1,this)" title="å†·æ°£"><div class="ac-vent"></div></div>
             <div class="dust-monster prop" id="prop-dust" onclick="findClue(2,this)" title="ç°å¡µ">ğŸŒ«ï¸</div>
             <div class="bibi-room prop" id="prop-bibi" onclick="findClue(3,this)" title="é¼»é¼»">â˜¯ï¸</div>
           </div>
           <div class="hidden" id="w2-quiz-area" style="margin-top:20px">
             <div style="font-weight:900;margin-bottom:10px;color:var(--bg2)">é¼»é¼»æƒ³å•å•ä½ ...</div>
             <div id="w2q1">
               <div style="font-size:14px;margin-bottom:6px">1. è½å®Œé€™äº›ï¼Œä½ æ¯”è¼ƒæ¥è¿‘å“ªç¨®æ„Ÿè¦ºï¼Ÿ</div>
               <button class="btn-choice" onclick="answerQ('q1','åŸä¾†ä¸æ˜¯æ¯å€‹äººéƒ½ä¸€æ¨£...','w2q1','w2q2')">åŸä¾†ä¸æ˜¯æ¯å€‹äººéƒ½ä¸€æ¨£å®¹æ˜“é¼»å­ä¸èˆ’æœ</button>
               <button class="btn-choice" onclick="answerQ('q1','æ²’æƒ³é','w2q1','w2q2')">æˆ‘ä»¥å‰æ²’æœ‰ç‰¹åˆ¥æƒ³éé€™ä»¶äº‹</button>
               <button class="btn-choice" onclick="answerQ('q1','ä¸ç¢ºå®š','w2q1','w2q2')">æˆ‘ç¾åœ¨é‚„ä¸å¤ªç¢ºå®š</button>
             </div>
             <div id="w2q2" class="hidden">
               <div style="font-size:14px;margin-bottom:6px">2. è½åˆ°ã€Œé«”è³ªã€é€™å€‹èªªæ³•ï¼Œä½ æœƒæ€éº¼æƒ³ï¼Ÿ</div>
               <button class="btn-choice" onclick="answerQ('q2','é›£æ‡‚','w2q2','w2q3')">å¥½åƒæœ‰é»é›£æ‡‚</button>
               <button class="btn-choice" onclick="answerQ('q2','å¯è§£é‡‹','w2q2','w2q3')">å¥½åƒå¯ä»¥è§£é‡‹ä¸€äº›ç‹€æ³</button>
               <button class="btn-choice" onclick="answerQ('q2','æ²’æ„Ÿè¦º','w2q2','w2q3')">æš«æ™‚æ²’æœ‰ä»€éº¼æ„Ÿè¦º</button>
             </div>
             <div id="w2q3" class="hidden">
               <div style="font-size:14px;margin-bottom:6px">3. æœ€å¾Œ... ä½ ç¾åœ¨æ¯”è¼ƒæ€éº¼æƒ³ï¼Ÿ</div>
               <button class="btn-choice" onclick="answerQ('q3','é¼»å­ä¸åŒ','w2q3','DONE')">åŸä¾†æ¯å€‹äººçš„é¼»å­çœŸçš„ä¸å¤ªä¸€æ¨£</button>
               <button class="btn-choice" onclick="answerQ('q3','é–‹å§‹ç†è§£','w2q3','DONE')">å¥½åƒé–‹å§‹ç†è§£ï¼Œç‚ºä»€éº¼æˆ‘æœƒç‰¹åˆ¥å®¹æ˜“ä¸èˆ’æœ</button>
               <button class="btn-choice" onclick="answerQ('q3','å¥½å¥‡','w2q3','DONE')">æˆ‘é‚„ä¸å¤ªæ‡‚ï¼Œä½†è¦ºå¾—æœ‰é»å¥½å¥‡</button>
             </div>
           </div>
           <div class="hidden" id="w2-done" style="text-align:center;padding:20px;color:var(--good);font-weight:900">Week 2 å…¨æ•¸å®Œæˆï¼</div>
        </div>
    </div>

    <div id="content-leader" class="hidden">
       <div class="league-badge" id="badgeArea">
         <div style="font-size:40px" id="badgeIcon">ğŸ¥‰</div>
         <div style="font-weight:900;color:var(--accent)" id="badgeName">éŠ…ç‰Œæ–°ç§€</div>
       </div>
       <div id="leaderList" class="leader-list"></div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal" onclick="closeModal()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div style="font-size:40px;margin-bottom:10px" id="m-icon"></div>
    <div style="font-weight:900;font-size:18px;margin-bottom:10px" id="m-title"></div>
    <div style="font-size:14px;color:#666;line-height:1.5" id="m-desc"></div>
    <div style="background:#f4f4f5;padding:10px;border-radius:10px;margin-top:15px;text-align:left;font-size:13px">
      <b>ğŸ—¨ï¸ é¼»é¼»ï¼š</b><span id="m-reply"></span>
    </div>
    <button class="btn" onclick="closeModal()">æ”¶åˆ°äº†</button>
  </div>
</div>

<script>
// âš ï¸ å¦³çš„ç¶²å€
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzWT_39e3ev68nMQhniLyBIGgkD-gqqBUGiWJ_6uAuAR7ILTwRKbPDTrXy3rcR_EMQbNw/exec"; 
const DB_KEY = "bibi_final_v25_map"; 

const W1_CARDS = [
  { id: 1, i:"ğŸ¤§", t:"é€£çºŒæ‰“å™´åš", d:"æœ€è¿‘ä½ æœ‰é€™æ¨£å—ï¼Ÿ" },
  { id: 2, i:"ğŸ’§", t:"æµæ¸…æ¾ˆé¼»æ°´", d:"åƒæ°´é¾é ­ä¸€æ¨£åœä¸ä¸‹ä¾†ï¼Ÿ" },
  { id: 3, i:"ğŸ‘ƒ", t:"é¼»å­ç™¢æˆ–é¼»å¡", d:"ä¸€ç›´æƒ³æ‰é¼»å­ï¼Ÿ" },
  { id: 4, i:"â„ï¸", t:"æ€•å†·æ°£/æº«å·®", d:"é‡åˆ°å†·æ°£å¼·çš„æ™‚å€™æœƒä¸èˆ’æœå—ï¼Ÿ" },
  { id: 5, i:"ğŸŒ«ï¸", t:"ç°å¡µ/èŠ±ç²‰", d:"æ‰“æƒæˆ–æ›å­£æ™‚ç‰¹åˆ¥æ˜é¡¯ï¼Ÿ" },
  { id: 6, i:"ğŸŒ…", t:"æ—©ä¸Šèµ·åºŠ", d:"å‰›é†’ä¾†æ™‚æœ€åš´é‡ï¼Ÿ" }
];

const W1_ACTIONS = [
  { t:"å°‘åƒå†°çš„", img:"ğŸ§Š" }, { t:"å®šæœŸæ´—åºŠå–®", img:"ğŸ›ï¸" }, { t:"è¦å¾‹æœè—¥", img:"ğŸ’Š" }, { t:"å‡ºé–€æˆ´å£ç½©", img:"ğŸ˜·" },
  { t:"å°‘æ”¾çµ¨æ¯›å¨ƒå¨ƒ", img:"ğŸ§¸" }, { t:"ä½œæ¯å›ºå®š", img:"â°" }, { t:"ä¿æŒé‹å‹•", img:"ğŸƒ" }, { t:"èµ·åºŠç©¿å¤–å¥—", img:"ğŸ§¥" }
];

const W2_STORY = [
  { t: "å°ä¸»äººï¼Œä¸Šé€±ä½ é™ªæˆ‘æ³¨æ„äº†å¾ˆå¤šç‹€æ³ï¼Œ\næˆ‘ä¸€ç›´æŠŠé‚£äº›äº‹æƒ…æ”¾åœ¨å¿ƒä¸Šã€‚", m: "ğŸ˜" },
  { t: "æœ‰æ™‚å€™æˆ‘ä¸€é€²å†·æ°£æˆ¿å°±å¾ˆä¸èˆ’æœï¼Œ\nå¯æ˜¯æ—é‚Šçš„äººå»å¥½åƒæ²’ä»€éº¼æ„Ÿè¦ºã€‚", m: "ğŸ¤§" },
  { t: "é‡åˆ°ç°å¡µæˆ–èŠ±ç²‰çš„æ™‚å€™ä¹Ÿæ˜¯ï¼Œ\næˆ‘æœƒä¸€ç›´æƒ³æ‰“å™´åšï¼Œä½†åˆ¥äººå»é‚„å¥½å¥½çš„ã€‚", m: "ğŸ˜£" },
  { t: "æ‰€ä»¥æˆ‘å°±åœ¨æƒ³ï¼Œ\næ˜¯ä¸æ˜¯æ¯å€‹äººçš„é¼»å­ï¼Œ\næœ¬ä¾†å°±ä¸å¤ªä¸€æ¨£å‘¢ï¼Ÿ", m: "ğŸ¤”" },
  { t: "æˆ‘è½èªªï¼Œä¸­é†«æœƒæŠŠé€™ç¨®\nã€æ¯å€‹äººå°ç’°å¢ƒåæ‡‰ä¸ä¸€æ¨£ã€çš„ç‹€æ³ï¼Œ\nå«åšã€é«”è³ªã€ã€‚", m: "ğŸ’¡" },
  { t: "ä¸æ˜¯èªªå“ªè£¡ä¸å¥½ï¼Œ\nåªæ˜¯æ¯å€‹äººæœ¬ä¾†å°±ä¸ä¸€æ¨£è€Œå·²ã€‚", m: "ğŸ˜Š" }
];

const W2_CLUES = {
  1: { t:"ç’°å¢ƒ", d:"æœ‰äº›äººå°å†·æ°£æˆ–æº«å·®æ¯”è¼ƒæ•æ„Ÿã€‚", r:"å°è€¶ï¼Œæˆ‘ä¸€é€²å†·æ°£æˆ¿çš„æ™‚å€™ï¼Œé¼»å­çœŸçš„æ¯”è¼ƒå®¹æ˜“ä¸èˆ’æœã€‚", i:"â„ï¸" },
  2: { t:"éæ•åŸ", d:"æœ‰äº›äººä¸€æ¥è§¸ç°å¡µæˆ–èŠ±ç²‰å°±æœƒæ‰“å™´åšã€‚", r:"æœ‰æ™‚å€™ä¸€ç¢°åˆ°ç°å¡µï¼Œæˆ‘å°±æœƒä¸€ç›´æƒ³æ‰“å™´åšã€‚", i:"ğŸŒ«ï¸" },
  3: { t:"ä¸­é†«è§€é»", d:"ä¸­é†«ç”¨ã€é«”è³ªã€å½¢å®¹æ¯å€‹äººåæ‡‰ä¸å¤ªä¸€æ¨£ã€‚", r:"åŸä¾†ä¸æ˜¯æ¯å€‹äººéƒ½ä¸€æ¨£ï¼Œåªæ˜¯åæ‡‰ä¸å¤ªä¸€æ¨£è€Œå·²ã€‚", i:"ğŸ§˜" }
};

let s = {};
try { s = JSON.parse(localStorage.getItem(DB_KEY)||"{}"); } catch(e) { s = {}; }
if(!s.hp) s = { hp:60, lv:1, exp:0, streak:0, w1s:false, w1d:false, w2s:false, w2d:false, nick:"" };

function save(){ localStorage.setItem(DB_KEY, JSON.stringify(s)); updateMapStatus(); }

let storyIdx = 0;
let curStory = null;
let cardIdx = 0;
let cluesFound = 0;
let selectedActions = new Set();
let w2Answers = { q1:"", q2:"", q3:"" };

function updateMapStatus(){
  const n1 = document.getElementById("node-w1");
  const n2 = document.getElementById("node-w2");
  
  if(s.w1d) { 
    n1.classList.add("done"); n1.classList.remove("active");
    n2.classList.remove("locked"); 
    if(!s.w2d) n2.classList.add("active");
    else n2.classList.add("done");
  }
}

function openLevel(level){
  if(level === 'w2' && !s.w1d) { alert("è«‹å…ˆå®Œæˆ Week 1 å–”ï¼ğŸ”’"); return; }
  
  document.getElementById("mapView").classList.add("hidden");
  document.getElementById("gameView").classList.add("show");
  
  // Hide all contents first
  document.getElementById("content-w1").classList.add("hidden");
  document.getElementById("content-w2").classList.add("hidden");
  document.getElementById("content-leader").classList.add("hidden");
  document.getElementById("charArea").classList.remove("hidden"); // é è¨­é¡¯ç¤ºè§’è‰²

  if(level === 'w1'){
    document.getElementById("viewTitle").innerText = "Week 1: ç—‡ç‹€è¦ºå¯Ÿ";
    document.getElementById("content-w1").classList.remove("hidden");
    if(!s.w1s && !s.w1d) { playStory('w1'); renderCard(); } 
    else if(s.w1s && !s.w1d) { renderCard(); }
    else if(s.w1d) { document.getElementById("w1-done").classList.remove("hidden"); document.getElementById("w1-game-ui").classList.add("hidden"); }
  } 
  else if(level === 'w2'){
    document.getElementById("viewTitle").innerText = "Week 2: å°‹æ‰¾ç·šç´¢";
    document.getElementById("content-w2").classList.remove("hidden");
    if(!s.w2s && !s.w2d) playStory('w2');
    else if(s.w2d) { document.getElementById("w2-done").classList.remove("hidden"); document.getElementById("w2-content").classList.add("hidden"); }
  }
  else if(level === 'leader'){
    document.getElementById("viewTitle").innerText = "ğŸ† æ’è¡Œæ¦œ";
    document.getElementById("content-leader").classList.remove("hidden");
    document.getElementById("charArea").classList.add("hidden"); // æ’è¡Œæ¦œä¸é¡¯ç¤ºè§’è‰²
    renderLeader();
  }
  
  renderStats();
}

function closeLevel(){
  document.getElementById("gameView").classList.remove("show");
  document.getElementById("mapView").classList.remove("hidden");
  updateMapStatus();
}

// æ•…äº‹èˆ‡éŠæˆ²é‚è¼¯
function playStory(type){
  curStory = type; storyIdx = 0;
  document.getElementById("btnNext").classList.remove("hidden");
  renderStoryFrame();
}

function renderStoryFrame(){
  const list = curStory==='w1' ? getW1Story() : W2_STORY;
  const item = list[storyIdx];
  if(curStory === 'w1' && item.action === 'askNick' && !s.nick) {
     document.getElementById("bubbleText").innerText = item.t;
     document.getElementById("nickInputArea").classList.remove("hidden");
     document.getElementById("btnNext").classList.add("hidden");
     return;
  }
  document.getElementById("bubbleText").innerText = item.t;
  document.getElementById("mood").innerText = item.m;
}

function getW1Story() {
  const n = s.nick || "å°ä¸»äºº";
  return [
    { t: "å—¨ï¼å°ä¸»äººä½ å¥½ï¼Œæˆ‘æ˜¯é¼»é¼»ï¼(æ®æ‰‹)", m: "ğŸ‘‹", action: "greet" },
    { t: "è«‹å•å°ä¸»äººä½ å«ä»€éº¼åå­—å‘¢ï¼Ÿ", m: "ğŸ¤”", action: "askNick" },
    { t: `${n}ä½ å¥½ï¼\nå…¶å¯¦... æˆ‘å¸¸å¸¸å› ç‚ºã€éæ•ã€è¦ºå¾—å¥½é›£å—ã€‚\n`, m: "ğŸ˜£" },
    { t: "æœ€è¿‘æˆ‘å¸¸å¸¸ä¸€é€£ä¸²åœ°æ‰“å™´åšï¼Œ\né¼»å­è£¡é¢ä¹Ÿå¾ˆç™¢ï¼Œé‚„ä¸€ç›´æµæ¸…æ¸…çš„é¼»æ°´ã€‚\n", m: "ğŸ¤§" },
    { t: "æœ‰æ™‚å€™é¼»å­æœƒæ‚¶æ‚¶çš„ï¼Œ\nå‘¼å¸ä¸å¤ªé †ï¼Œæ—©ä¸Šèµ·åºŠæ™‚ç‰¹åˆ¥æ˜é¡¯ã€‚\n", m: "ğŸ˜" },
    { t: "æˆ‘ç™¼ç¾åªè¦é‡åˆ°ç°å¡µã€èŠ±ç²‰ï¼Œ\næˆ–å†·æ°£é–‹å¾ˆå¼·ã€æº«å·®è®Šå¤§çš„æ™‚å€™ï¼Œ\né€™äº›ä¸èˆ’æœå¥½åƒå°±æœƒæ›´æ˜é¡¯ã€‚\n", m: "ğŸŒ¡ï¸" },
    { t: "æˆ‘ä¹Ÿä¸ç¢ºå®šç‚ºä»€éº¼æœƒé€™æ¨£...\nä½ å¯ä»¥é™ªæˆ‘ç©å€‹å°éŠæˆ²ï¼Œ\nç¢ºèªä¸€ä¸‹æˆ‘å€‘ä»€éº¼æ™‚å€™æ¯”è¼ƒå®¹æ˜“ä¸èˆ’æœå—ï¼Ÿ\n", m: "ğŸ¥º" }
  ];
}

function confirmNick(){
  const input = document.getElementById("nickInput");
  const val = input.value.trim();
  if(!val) return alert("è«‹è¼¸å…¥ä¸€å€‹æš±ç¨±å–”ï¼");
  s.nick = val; save();
  document.getElementById("nickInputArea").classList.add("hidden");
  document.getElementById("btnNext").classList.remove("hidden");
  document.getElementById("bubbleText").innerText = `å¾ˆé«˜èˆˆèªè­˜ä½ ï¼Œ${val}ï¼`;
}

function nextStory(){
  const list = curStory==='w1' ? getW1Story() : W2_STORY;
  storyIdx++;
  if(storyIdx >= list.length){
    document.getElementById("btnNext").classList.add("hidden");
    if(curStory === 'w1') {
       s.w1s = true; 
       document.getElementById("bubbleText").innerText = "æˆ‘å€‘é–‹å§‹å§ï¼è«‹æŒ‰ä¸‹é¢çš„ O æˆ– X ã€‚";
       renderCard();
    }
    if(curStory === 'w2') {
       s.w2s = true;
       document.getElementById("bubbleText").innerText = "è«‹å¹«æˆ‘æ‰¾å‡ºé€™ 3 å€‹ç·šç´¢ã€‚";
    }
    save(); curStory = null;
  } else { renderStoryFrame(); }
}

function renderCard(){
  const box = document.getElementById("card-stage"); box.innerHTML = "";
  if(cardIdx >= W1_CARDS.length) { showActionSelect(); return; }
  const c = W1_CARDS[cardIdx];
  const div = document.createElement("div"); div.className = "tinder-card"; div.id = "active-card";
  div.innerHTML = `<div class="tc-icon">${c.i}</div><div class="tc-title">${c.t}</div><div class="tc-desc">${c.d}</div>`;
  box.appendChild(div);
}

function swipe(dir){
  const card = document.getElementById("active-card"); if(!card) return;
  card.classList.add(dir==='left'?'swipe-left':'swipe-right');
  setTimeout(()=>{ cardIdx++; renderCard(); }, 400);
}

function showActionSelect() {
  document.getElementById("w1-game-ui").classList.add("hidden");
  document.getElementById("w1-action-ui").classList.remove("hidden");
  const grid = document.getElementById("action-stage");
  grid.innerHTML = W1_ACTIONS.map((a, i) => `
    <div class="action-card" id="act-${i}" onclick="toggleAction(${i})">
      <div class="action-emoji">${a.img}</div><div class="action-text">${a.t}</div>
    </div>`).join("");
  document.getElementById("bubbleText").innerText = "é€™äº›éƒ½æ˜¯å¾ˆå¥½çš„å˜—è©¦ï¼Œä½ å¯ä»¥é¸ä¸€å€‹ï¼Œä¹Ÿå¯ä»¥é¸å¾ˆå¤šå€‹ï¼";
}

function toggleAction(i) {
  const el = document.getElementById(`act-${i}`);
  if(selectedActions.has(i)) { selectedActions.delete(i); el.classList.remove("selected"); } 
  else { selectedActions.add(i); el.classList.add("selected"); }
}

function submitActions() {
  if(selectedActions.size === 0) { alert("è«‹è‡³å°‘é¸ä¸€å€‹è©¦è©¦çœ‹å–”ï¼"); return; }
  const choiceNames = Array.from(selectedActions).map(i => W1_ACTIONS[i].t).join(", ");
  
  // æ–‡å­—ä¿®æ”¹ï¼šæ›´æœ‰å»¶çºŒæ„Ÿ
  document.getElementById("bubbleText").innerText = "Week 1 é †åˆ©å®Œæˆï¼ğŸ‰\nè¬è¬ä½ é™ªæˆ‘ä¸€èµ·ç·´ç¿’ã€‚\n\næº–å‚™å¥½æˆ‘å€‘å°±è¦é€²å…¥ä¸‹é€±ï¼ˆWeek 2ï¼‰äº†å—ï¼Ÿ";
  document.getElementById("mood").innerText = "ğŸ˜";
  
  setTimeout(() => { finishW1(choiceNames); }, 2000);
}

function finishW1(choiceNames){
  if(s.w1d) return;
  s.w1d = true; s.exp+=20; s.hp+=10; save();
  sendData("W1", { action: choiceNames, w2_done: "No" });
  document.getElementById("w1-action-ui").classList.add("hidden");
  document.getElementById("w1-done").classList.remove("hidden");
  renderStats();
}

function findClue(id, el){
  if(el.classList.contains("found")) return;
  const c = W2_CLUES[id];
  document.getElementById("m-icon").innerText = c.i;
  document.getElementById("m-title").innerText = c.t;
  document.getElementById("m-desc").innerText = c.d;
  document.getElementById("m-reply").innerText = c.r;
  document.getElementById("modal").classList.add("show");
  document.getElementById("bubbleText").innerText = c.r;
  el.classList.add("found"); cluesFound++;
  if(cluesFound >= 3){
    setTimeout(()=>{
       document.getElementById("w2-quiz-area").classList.remove("hidden");
       document.getElementById("w2-quiz-area").scrollIntoView({behavior:"smooth"});
       document.getElementById("bubbleText").innerText = "å¥½åƒçœŸçš„æœ‰ä¸åŒçš„å¯èƒ½ï¼Œæˆ‘æƒ³å†è½è½ä½ çš„æƒ³æ³•ã€‚";
    }, 1000);
  }
}

function answerQ(qid, ansText, hideId, showId){
   w2Answers[qid] = ansText;
   if(showId === 'DONE'){ finishW2(); } 
   else { document.getElementById(hideId).classList.add("hidden"); document.getElementById(showId).classList.remove("hidden"); }
}

function finishW2(){
  if(s.w2d) return;
  s.w2d = true; s.exp+=30; s.hp=100; s.lv++; save();
  sendData("W2", { w2_done: "Yes", q1_ans: w2Answers.q1, q2_ans: w2Answers.q2, q3_ans: w2Answers.q3 });
  alert("Week 2 å®Œæˆï¼");
  document.getElementById("bubbleText").innerText = "è¬è¬ä½ é™ªæˆ‘ä¸€èµ·æƒ³é€™äº›äº‹æƒ…ã€‚";
  document.getElementById("w2-done").classList.remove("hidden");
  document.getElementById("w2-quiz-area").classList.add("hidden");
  renderStats();
}

function renderStats(){
  document.getElementById("hpVal").innerText = s.hp;
  document.getElementById("hpBar").style.width = s.hp + "%";
  document.getElementById("lvVal").innerText = s.lv;
  document.getElementById("lvBar").style.width = ((s.exp%50)*2) + "%";
}

function renderLeader(){
  const myName = s.nick || "æˆ‘"; const myExp = s.exp;
  let rankName = "ğŸ¥‰ éŠ…ç‰Œæ–°ç§€"; let rankIcon = "ğŸ¥‰"; let rankColor = "#cd7f32";
  if(myExp >= 50) { rankName = "ğŸ¥ˆ éŠ€ç‰Œé«˜æ‰‹"; rankIcon = "ğŸ¥ˆ"; rankColor = "#7f8c8d"; }
  if(myExp >= 100) { rankName = "ğŸ’ é‘½çŸ³å¤§å¸«"; rankIcon = "ğŸ’"; rankColor = "#3498db"; }
  
  document.getElementById("badgeIcon").innerText = rankIcon;
  document.getElementById("badgeName").innerText = rankName;
  document.getElementById("badgeName").style.color = rankColor;

  const fakeUsers = [
    { n: "å°å‚‘", e: myExp + 15, a: "ğŸ‘¦" }, { n: "é˜¿è±ª", e: myExp + 5, a: "ğŸ˜" },
    { n: "Yumi", e: Math.max(0, myExp - 10), a: "ğŸ‘§" }, { n: "å°ç¾", e: Math.max(0, myExp - 25), a: "ğŸ‘±â€â™€ï¸" }
  ];
  const myList = [...fakeUsers, { n: myName, e: myExp, a: "ğŸ˜Š", me: true }];
  myList.sort((a,b) => b.e - a.e);
  
  document.getElementById("leaderList").innerHTML = myList.map((u, i) => `
    <div class="leader-item ${u.me ? 'me' : ''}">
      <div class="rank-num">${i+1}</div>
      <div class="user-info"><div class="user-avatar">${u.a}</div><div class="user-name">${u.n}</div></div>
      <div class="user-exp">${u.e} EXP</div>
    </div>`).join("");
}

function sendData(type, payload) {
  const finalData = Object.assign({}, { nick: s.nick, exp: s.exp }, payload);
  fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(finalData), headers: {'Content-Type': 'application/json'} });
}

function closeModal(){ document.getElementById("modal").classList.remove("show"); }
function pokeBibi(){ document.getElementById("bubbleText").innerText = "ä»Šå¤©ä¹Ÿè¦åŠ æ²¹å–”ï¼"; }
function setNick(){ const n=prompt("ä¿®æ”¹æš±ç¨±", s.nick); if(n){s.nick=n;save();} }
function resetAll(){ localStorage.removeItem(DB_KEY); location.reload(); }

updateMapStatus();
renderStats();
</script>
</body>
</html>
