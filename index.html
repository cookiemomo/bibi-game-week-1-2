<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>é¼»é¼»é¤Šæˆé—–é—œï½œWeek 1-2 æœ€çµ‚ç‰ˆ</title>
  <style>
    /* ===== æ ¸å¿ƒè®Šæ•¸ ===== */
    :root{
      --bg1:#2b1b14; --bg2:#7a4b2b;
      --panel:#f4e2c8; --panel2:#f0d6b0;
      --ink:#1a1412; --muted:#5b4b42;
      --accent:#ffb23f; --accent2:#ff7a59;
      --good:#1b7f4b; --bad:#b45309;
      --round:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,"Microsoft JhengHei",sans-serif;
      color:var(--ink); min-height:100vh;
      background: radial-gradient(circle at 50% 10%, rgba(255,255,255,0.1), transparent), linear-gradient(155deg, var(--bg1), var(--bg2));
      overflow-x: hidden;
    }
    .wrap{max-width:980px;margin:0 auto;padding:16px 14px 92px;}
    
    /* é ‚éƒ¨ */
    .topbar{display:flex;justify-content:space-between;align-items:center;color:#fff;margin-bottom:12px}
    .brand{font-weight:900;font-size:18px}
    .btnTiny{background:rgba(0,0,0,.2);color:#fff;border:1px solid rgba(255,255,255,.2);padding:6px 10px;border-radius:12px;cursor:pointer;font-size:12px}

    /* ä½ˆå±€ */
    .grid{display:grid;gap:12px;grid-template-columns: 320px 1fr;}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
    
    .card{
      background:linear-gradient(180deg, var(--panel), var(--panel2));
      border-radius:var(--round);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      overflow:hidden; position: relative;
    }
    .cardPad{padding:14px}
    
    /* å·¦å´ï¼šè§’è‰²å€ */
    .charStage{
      padding:14px; min-height:540px;
      background: radial-gradient(circle at 50% 30%, rgba(255,255,255,0.8), rgba(255,255,255,0.2));
      display: flex; flex-direction: column; position: relative;
    }
    .stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:15px;}
    .statBox{background:rgba(255,255,255,.6);border-radius:12px;padding:8px;}
    .statName{font-size:11px;color:var(--muted);font-weight:900}
    .statVal{font-size:15px;font-weight:900;}
    .bar{height:6px;background:rgba(0,0,0,.1);border-radius:4px;margin-top:4px;overflow:hidden}
    .bar>div{height:100%;background:var(--accent2);transition:width .3s}

    /* é¼»é¼»åœ–åƒ (Emoji) */
    .bibi-container { 
      margin: auto; width: 220px; height: 220px; position: relative; cursor: pointer; 
      display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.3); border-radius: 50%;
    }
    .bibi-emoji { font-size: 120px; filter: drop-shadow(0 8px 16px rgba(0,0,0,0.15)); transition: transform .1s; }
    .bibi-emoji:active { transform: scale(0.95); }
    .bibiMood {
      position: absolute; bottom: 10px; right: 10px;
      font-size: 32px; background: #fff; border-radius: 50%; width: 50px; height: 50px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    /* å°è©±æ¡† */
    .bubble {
      margin-top: auto; background: #fff; border: 2px solid var(--ink); border-radius: 18px;
      padding: 16px; position: relative; min-height: 120px;
      display: flex; flex-direction: column; justify-content: space-between;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    .bubble::after {
      content: ""; position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
      border-width: 0 10px 10px; border-style: solid; border-color: transparent transparent var(--ink);
    }
    .bubbleText { font-size: 15px; line-height: 1.5; font-weight: 500; white-space: pre-line; color: var(--ink); }
    
    .btnNext {
      align-self: flex-end; background: var(--ink); color: #fff; border: none;
      padding: 6px 14px; border-radius: 20px; font-size: 12px; cursor: pointer; margin-top: 8px;
      animation: bounce 1s infinite;
    }
    @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-3px)} }

    /* æš±ç¨±è¼¸å…¥å€ */
    .nick-input-area { display: flex; gap: 8px; margin-top: 10px; }
    .nick-input { flex: 1; padding: 8px 12px; border: 2px solid var(--accent); border-radius: 12px; font-size: 14px; outline: none; }
    .btn-confirm { background: var(--good); color: #fff; border: none; padding: 8px 14px; border-radius: 12px; font-weight: bold; cursor: pointer; }

    /* Tabs */
    .tabs{display:flex;gap:8px;padding:10px;background:rgba(0,0,0,.1);}
    .tab{
      padding:8px 14px;border-radius:12px;font-weight:900;font-size:13px;
      background:rgba(255,255,255,.4); border:1px solid rgba(0,0,0,.05); cursor:pointer;
    }
    .tab.active{background:#fff; transform:scale(1.05); box-shadow:0 4px 8px rgba(0,0,0,0.1);}
    .pane{display:none;}
    .pane.active{display:block; animation: fadeIn .3s;}
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

    /* Week 1 æ»‘å¡ */
    .tinder-container {
      position: relative; width: 100%; height: 320px; margin: 20px auto;
      display: flex; align-items: center; justify-content: center;
    }
    .tinder-card {
      position: absolute; width: 260px; height: 320px;
      background: #fff; border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 24px; text-align: center; border: 1px solid rgba(0,0,0,0.05);
      transition: transform .4s, opacity .4s; z-index: 2;
    }
    .tinder-card.swipe-left { transform: translateX(-150%) rotate(-20deg); opacity: 0; }
    .tinder-card.swipe-right { transform: translateX(150%) rotate(20deg); opacity: 0; }
    .tc-icon { font-size: 64px; margin-bottom: 20px; }
    .tc-title { font-size: 20px; font-weight: 900; margin-bottom: 10px; }
    .tc-desc { font-size: 14px; color: var(--muted); line-height: 1.6; }
    
    .swipe-actions { display: flex; justify-content: center; gap: 30px; margin-top: 10px; }
    .btn-round {
      width: 60px; height: 60px; border-radius: 50%; border: 0; font-size: 24px;
      display: flex; align-items: center; justify-content: center; cursor: pointer;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: transform .1s;
    }
    .btn-no { background: #fff; color: var(--bad); border: 2px solid #eee; }
    .btn-yes { background: #fff; color: var(--good); border: 2px solid #eee; }
    .btn-round:active { transform: scale(0.9); }

    /* Week 1 åœ–ç‰‡é¸æ“‡ (Q4 - æ”¹ç”¨ Emoji é˜²æ­¢ç ´åœ–) */
    .action-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
      max-height: 380px; overflow-y: auto; padding: 4px;
    }
    .action-card {
      background: #fff; border-radius: 12px; overflow: hidden;
      border: 2px solid transparent; cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: transform .2s, border-color .2s;
      position: relative;
      display: flex; flex-direction: column; align-items: center; padding: 15px;
    }
    .action-card.selected { border-color: var(--good); background-color: rgba(27, 127, 75, 0.05); transform: translateY(-2px); }
    .action-card.selected::after {
      content: "âœ”"; position: absolute; top: 5px; right: 5px;
      background: var(--good); color: #fff; width: 24px; height: 24px;
      border-radius: 50%; font-size: 14px; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .action-emoji { font-size: 40px; margin-bottom: 8px; }
    .action-text { font-size: 13px; font-weight: bold; color: var(--ink); line-height: 1.4; text-align: center; }

    /* Week 2 åµæ¢ (å«çœŸå¯¦æˆ¿é–“èƒŒæ™¯) */
    .room-container {
      position: relative; width: 100%; height: 300px;
      border-radius: 16px; margin-top: 10px; border: 4px solid #fff;
      /* ğŸŒŸ 1. çœŸå¯¦è‡¥å®¤èƒŒæ™¯åœ– */
      background-image: url('https://images.unsplash.com/photo-1540518614846-7eded433c457?q=80&w=800&auto=format&fit=crop');
      background-size: cover; background-position: center;
      box-shadow: inset 0 0 40px rgba(0,0,0,.2);
      overflow: hidden;
    }
    
    .prop {
      position: absolute; cursor: pointer; 
      transition: transform 0.2s, filter 0.2s;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
      z-index: 10;
      display: flex; flex-direction: column; align-items: center;
    }
    .prop:hover { transform: scale(1.1); }
    .prop.found { filter: grayscale(1) opacity(0.5); transform: scale(0.9); }
    
    .ac-unit {
      top: 20px; left: 30px; width: 80px; height: 35px;
      background: rgba(255,255,255,0.95); border-radius: 6px; border: 1px solid #ddd;
      display: flex; align-items: flex-end; justify-content: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .ac-vent { width: 80%; height: 4px; background: #333; margin-bottom: 6px; border-radius: 2px; }

    .dust-monster {
      bottom: 30%; left: 20%; width: 40px; height: 40px;
      background: rgba(85,85,85,0.8); border-radius: 50%;
      animation: float 3s infinite ease-in-out;
      display: flex; align-items: center; justify-content: center; color: white; font-size: 20px;
    }
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }

    .bibi-room {
      bottom: 20px; right: 40px; font-size: 60px;
      text-shadow: 0 0 10px rgba(255,255,255,0.8);
    }

    /* === æ’è¡Œæ¦œæ¨£å¼ (éŠ…ç‰Œ/éŠ€ç‰Œ/é‘½çŸ³) === */
    .leader-list { width: 100%; display: flex; flex-direction: column; gap: 8px; }
    .leader-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px; border-radius: 16px; background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05); border: 2px solid transparent;
    }
    .leader-item.me { border-color: var(--accent); background: #fffdf5; }
    .rank-num { font-weight: 900; color: var(--muted); width: 30px; text-align: center; }
    .user-info { flex: 1; display: flex; align-items: center; gap: 10px; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .user-name { font-weight: 900; font-size: 14px; }
    .user-exp { font-weight: bold; color: var(--good); }
    .league-badge { text-align: center; margin-bottom: 15px; }
    
    /* é€šç”¨å…ƒä»¶ */
    .btn { background: var(--ink); color: #fff; width: 100%; padding: 14px; border-radius: 14px; border: 0; font-weight: 900; cursor: pointer; margin-top: 10px; }
    .btn-choice { background: #fff; width: 100%; padding: 12px; border-radius: 12px; border: 1px solid rgba(0,0,0,.1); margin-top: 8px; text-align: left; cursor: pointer; }
    .btn-choice:hover { background: #f9f9f9; border-color: var(--accent); }
    .board { width: 100%; font-size: 13px; } .board td { padding: 8px; border-bottom: 1px solid rgba(0,0,0,.05); }
    
    .hidden { display: none !important; }
    .lock-overlay { position: absolute; inset: 0; background: rgba(255,255,255,.7); backdrop-filter: blur(4px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 50; border-radius: 16px; color: var(--muted); font-weight: 900; }
    
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.6); z-index: 999; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: .3s; }
    .modal-overlay.show { opacity: 1; pointer-events: auto; }
    .modal-box { background: #fff; width: 90%; max-width: 380px; padding: 24px; border-radius: 24px; text-align: center; }
  </style>
</head>
<body>

<div class="wrap">
  <div class="topbar">
    <div class="brand">é¼»é¼»é¤Šæˆé—–é—œ <span class="tag">Week 1-2</span></div>
    <div class="row">
      <button class="btnTiny" onclick="setNick()">ä¿®æ”¹æš±ç¨±</button>
      <button class="btnTiny" onclick="resetAll()">é‡ç½®</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="charStage">
        <div class="stats">
          <div class="statBox"><div class="statName">HP</div><div class="statVal" id="hpVal">60</div><div class="bar"><div id="hpBar" style="width:60%"></div></div></div>
          <div class="statBox"><div class="statName">LV</div><div class="statVal" id="lvVal">1</div><div class="bar"><div id="lvBar" style="width:0%"></div></div></div>
        </div>
        
        <div class="bibi-container" onclick="pokeBibi()">
           <div class="bibi-emoji" id="mainBibi">ğŸ¤§</div>
           <div class="bibiMood" id="mood">ğŸ‘‹</div>
        </div>

        <div class="bubble">
          <div>
             <div style="font-size:12px;color:var(--bg2);font-weight:900;margin-bottom:4px">ğŸ—¨ï¸ é¼»é¼»</div>
             <div class="bubbleText" id="bubbleText">......</div>
             
             <div id="nickInputArea" class="nick-input-area hidden">
                <input type="text" id="nickInput" class="nick-input" placeholder="è¼¸å…¥ä½ çš„æš±ç¨±...">
                <button class="btn-confirm" onclick="confirmNick()">ç¢ºèª</button>
             </div>
          </div>
          <button class="btnNext hidden" id="btnNext" onclick="nextStory()">ä¸‹ä¸€æ­¥ â–¶</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="tabs">
        <button class="tab active" id="t1" onclick="switchTab('w1')">Week 1 è¦ºå¯Ÿ</button>
        <button class="tab" id="t2" onclick="switchTab('w2')">Week 2 ç·šç´¢</button>
        <button class="tab" id="t3" onclick="switchTab('leader')">ğŸ† æ’è¡Œæ¦œ</button>
      </div>
      <div class="cardPad">

        <div class="pane active" id="p-w1">
          <div class="lock-overlay hidden" id="w1-story-lock">
            <div style="font-size:40px">ğŸ“–</div>
            <div style="margin-top:10px">è«‹å…ˆè½è½é¼»é¼»çš„ç…©æƒ±...</div>
          </div>

          <div id="w1-game-ui">
             <div style="font-weight:900;margin-bottom:10px;color:var(--muted)">Week 1: ç—‡ç‹€è¦ºå¯Ÿ</div>
             <div style="font-size:13px;color:#888;margin-bottom:10px">è«‹æŒ‰ä¸‹é¢çš„ O æˆ– X å›ç­”ï¼š</div>
             <div class="tinder-container" id="card-stage"></div>
             <div class="swipe-actions" id="swipe-btns">
               <button class="btn-round btn-no" onclick="swipe('left')">âŒ</button>
               <button class="btn-round btn-yes" onclick="swipe('right')">â­•</button>
             </div>
          </div>

          <div class="hidden" id="w1-action-ui">
             <div style="font-weight:900;margin-bottom:6px;color:var(--accent2)">â­ ä»Šå¤©é¡˜æ„å…ˆå˜—è©¦çš„å°è¡Œå‹•ï¼Ÿ</div>
             <div style="font-size:13px;color:#888;margin-bottom:10px">å¯ä»¥é¸å¾ˆå¤šå€‹ï¼Œé¸å®ŒæŒ‰ä¸‹æ–¹æŒ‰éˆ•ï¼</div>
             <div class="action-grid" id="action-stage"></div>
             <button class="btn" style="background:linear-gradient(90deg, var(--good), #2ecc71);color:white;" onclick="submitActions()">æ±ºå®šå¥½äº†ï¼</button>
          </div>

          <div class="hidden" id="w1-done" style="text-align:center;padding:30px">
            <div style="font-size:50px;margin-bottom:10px">âœ¨</div>
            <div style="font-weight:900;color:var(--good)">Week 1 å®Œæˆï¼</div>
            <p style="font-size:13px;color:#888;line-height:1.6">ç²å¾— 20 EXPã€‚<br>è¬è¬ä½ è½æˆ‘èªªï¼Œä¹Ÿè§€å¯Ÿäº†è‡ªå·±ã€‚</p>
            <button class="btn" onclick="switchTab('w2')">é€²å…¥ Week 2 âœ</button>
          </div>
        </div>

        <div class="pane" id="p-w2">
          <div class="lock-overlay" id="w2-lock">
            <div style="font-size:40px">ğŸ”’</div>
            <div style="margin-top:10px">è«‹å…ˆå®Œæˆ Week 1</div>
          </div>
          <div class="lock-overlay hidden" id="w2-story-lock">
            <div style="font-size:40px">ğŸ¤”</div>
            <div style="margin-top:10px">é¼»é¼»æ­£åœ¨æ€è€ƒ...</div>
          </div>

          <div id="w2-content">
             <div style="font-weight:900;margin-bottom:6px;color:var(--muted)">Week 2: å°‹æ‰¾ç·šç´¢</div>
             <div style="font-size:13px;color:#888;margin-bottom:10px">è«‹æ‰¾å‡ºæˆ¿é–“è£¡çš„ï¼šå†·æ°£ã€ç°å¡µã€å’Œé¼»é¼»</div>
             
             <div class="room-container">
               <div class="ac-unit prop" id="prop-ac" onclick="findClue(1,this)" title="å†·æ°£">
                 <div class="ac-vent"></div>
               </div>
               <div class="dust-monster prop" id="prop-dust" onclick="findClue(2,this)" title="ç°å¡µ">
                 ğŸŒ«ï¸
               </div>
               <div class="bibi-room prop" id="prop-bibi" onclick="findClue(3,this)" title="é¼»é¼»">
                 â˜¯ï¸
               </div>
             </div>

             <div class="hidden" id="w2-quiz-area" style="margin-top:20px">
               <div style="font-weight:900;margin-bottom:10px;color:var(--bg2)">é¼»é¼»æƒ³å•å•ä½ ...</div>
               <div id="w2q1">
                 <div style="font-size:14px;margin-bottom:6px">1. è½å®Œé€™äº›ï¼Œä½ æ¯”è¼ƒæ¥è¿‘å“ªç¨®æ„Ÿè¦ºï¼Ÿ</div>
                 <button class="btn-choice" onclick="answerQ('q1','åŸä¾†ä¸æ˜¯æ¯å€‹äººéƒ½ä¸€æ¨£...','w2q1','w2q2')">åŸä¾†ä¸æ˜¯æ¯å€‹äººéƒ½ä¸€æ¨£å®¹æ˜“é¼»å­ä¸èˆ’æœ</button>
                 <button class="btn-choice" onclick="answerQ('q1','æ²’æƒ³é','w2q1','w2q2')">æˆ‘ä»¥å‰æ²’æœ‰ç‰¹åˆ¥æƒ³éé€™ä»¶äº‹</button>
                 <button class="btn-choice" onclick="answerQ('q1','ä¸ç¢ºå®š','w2q1','w2q2')">æˆ‘ç¾åœ¨é‚„ä¸å¤ªç¢ºå®š</button>
               </div>
               <div id="w2q2" class="hidden">
                 <div style="font-size:14px;margin-bottom:6px">2. è½åˆ°ã€Œé«”è³ªã€é€™å€‹èªªæ³•ï¼Œä½ æœƒæ€éº¼æƒ³ï¼Ÿ</div>
                 <button class="btn-choice" onclick="answerQ('q2','é›£æ‡‚','w2q2','w2q3')">å¥½åƒæœ‰é»é›£æ‡‚</button>
                 <button class="btn-choice" onclick="answerQ('q2','å¯è§£é‡‹','w2q2','w2q3')">å¥½åƒå¯ä»¥è§£é‡‹ä¸€äº›ç‹€æ³</button>
                 <button class="btn-choice" onclick="answerQ('q2','æ²’æ„Ÿè¦º','w2q2','w2q3')">æš«æ™‚æ²’æœ‰ä»€éº¼æ„Ÿè¦º</button>
               </div>
               <div id="w2q3" class="hidden">
                 <div style="font-size:14px;margin-bottom:6px">3. æœ€å¾Œ... ä½ ç¾åœ¨æ¯”è¼ƒæ€éº¼æƒ³ï¼Ÿ</div>
                 <button class="btn-choice" onclick="answerQ('q3','é¼»å­ä¸åŒ','w2q3','DONE')">åŸä¾†æ¯å€‹äººçš„é¼»å­çœŸçš„ä¸å¤ªä¸€æ¨£</button>
                 <button class="btn-choice" onclick="answerQ('q3','é–‹å§‹ç†è§£','w2q3','DONE')">å¥½åƒé–‹å§‹ç†è§£ï¼Œç‚ºä»€éº¼æˆ‘æœƒç‰¹åˆ¥å®¹æ˜“ä¸èˆ’æœ</button>
                 <button class="btn-choice" onclick="answerQ('q3','å¥½å¥‡','w2q3','DONE')">æˆ‘é‚„ä¸å¤ªæ‡‚ï¼Œä½†è¦ºå¾—æœ‰é»å¥½å¥‡</button>
               </div>
             </div>

             <div class="hidden" id="w2-done" style="text-align:center;padding:20px;color:var(--good);font-weight:900">Week 2 å…¨æ•¸å®Œæˆï¼</div>
          </div>
        </div>

        <div class="pane" id="p-leader">
           <div class="league-badge" id="badgeArea">
             <div style="font-size:40px" id="badgeIcon">ğŸ¥‰</div>
             <div style="font-weight:900;color:var(--accent)" id="badgeName">éŠ…ç‰Œæ–°ç§€</div>
           </div>
           <div id="leaderList" class="leader-list">
             </div>
        </div>

      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal" onclick="closeModal()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div style="font-size:40px;margin-bottom:10px" id="m-icon"></div>
    <div style="font-weight:900;font-size:18px;margin-bottom:10px" id="m-title"></div>
    <div style="font-size:14px;color:#666;line-height:1.5" id="m-desc"></div>
    <div style="background:#f4f4f5;padding:10px;border-radius:10px;margin-top:15px;text-align:left;font-size:13px">
      <b>ğŸ—¨ï¸ é¼»é¼»ï¼š</b><span id="m-reply"></span>
    </div>
    <button class="btn" onclick="closeModal()">æ”¶åˆ°äº†</button>
  </div>
</div>

<script>
// âš ï¸ å¦³çš„è³‡æ–™æ”¶é›†ç¶²å€
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzWT_39e3ev68nMQhniLyBIGgkD-gqqBUGiWJ_6uAuAR7ILTwRKbPDTrXy3rcR_EMQbNw/exec"; 

// âš ï¸ æ›´æ–°Keyä»¥é‡ç½®æ•¸æ“šï¼Œç¢ºä¿å¾éŠ…ç‰Œé–‹å§‹
const DB_KEY = "bibi_final_v24_perfect"; 

const W1_CARDS = [
  { id: 1, i:"ğŸ¤§", t:"é€£çºŒæ‰“å™´åš", d:"æœ€è¿‘ä½ æœ‰é€™æ¨£å—ï¼Ÿ" },
  { id: 2, i:"ğŸ’§", t:"æµæ¸…æ¾ˆé¼»æ°´", d:"åƒæ°´é¾é ­ä¸€æ¨£åœä¸ä¸‹ä¾†ï¼Ÿ" },
  { id: 3, i:"ğŸ‘ƒ", t:"é¼»å­ç™¢æˆ–é¼»å¡", d:"ä¸€ç›´æƒ³æ‰é¼»å­ï¼Ÿ" },
  { id: 4, i:"â„ï¸", t:"æ€•å†·æ°£/æº«å·®", d:"é‡åˆ°å†·æ°£å¼·çš„æ™‚å€™æœƒä¸èˆ’æœå—ï¼Ÿ" },
  { id: 5, i:"ğŸŒ«ï¸", t:"ç°å¡µ/èŠ±ç²‰", d:"æ‰“æƒæˆ–æ›å­£æ™‚ç‰¹åˆ¥æ˜é¡¯ï¼Ÿ" },
  { id: 6, i:"ğŸŒ…", t:"æ—©ä¸Šèµ·åºŠ", d:"å‰›é†’ä¾†æ™‚æœ€åš´é‡ï¼Ÿ" }
];

// ä½¿ç”¨ Emoji æ›¿ä»£åœ–ç‰‡ï¼Œé˜²æ­¢ç ´åœ–
const W1_ACTIONS = [
  { t:"å°‘åƒå†°çš„", img:"ğŸ§Š" },
  { t:"å®šæœŸæ´—åºŠå–®", img:"ğŸ›ï¸" },
  { t:"è¦å¾‹æœè—¥", img:"ğŸ’Š" },
  { t:"å‡ºé–€æˆ´å£ç½©", img:"ğŸ˜·" },
  { t:"å°‘æ”¾çµ¨æ¯›å¨ƒå¨ƒ", img:"ğŸ§¸" },
  { t:"ä½œæ¯å›ºå®š", img:"â°" },
  { t:"ä¿æŒé‹å‹•", img:"ğŸƒ" },
  { t:"èµ·åºŠç©¿å¤–å¥—", img:"ğŸ§¥" }
];

const W2_STORY = [
  { t: "å°ä¸»äººï¼Œä¸Šé€±ä½ é™ªæˆ‘æ³¨æ„äº†å¾ˆå¤šç‹€æ³ï¼Œ\næˆ‘ä¸€ç›´æŠŠé‚£äº›äº‹æƒ…æ”¾åœ¨å¿ƒä¸Šã€‚", m: "ğŸ˜" },
  { t: "æœ‰æ™‚å€™æˆ‘ä¸€é€²å†·æ°£æˆ¿å°±å¾ˆä¸èˆ’æœï¼Œ\nå¯æ˜¯æ—é‚Šçš„äººå»å¥½åƒæ²’ä»€éº¼æ„Ÿè¦ºã€‚", m: "ğŸ¤§" },
  { t: "é‡åˆ°ç°å¡µæˆ–èŠ±ç²‰çš„æ™‚å€™ä¹Ÿæ˜¯ï¼Œ\næˆ‘æœƒä¸€ç›´æƒ³æ‰“å™´åšï¼Œä½†åˆ¥äººå»é‚„å¥½å¥½çš„ã€‚", m: "ğŸ˜£" },
  { t: "æ‰€ä»¥æˆ‘å°±åœ¨æƒ³ï¼Œ\næ˜¯ä¸æ˜¯æ¯å€‹äººçš„é¼»å­ï¼Œ\næœ¬ä¾†å°±ä¸å¤ªä¸€æ¨£å‘¢ï¼Ÿ", m: "ğŸ¤”" },
  { t: "æˆ‘è½èªªï¼Œä¸­é†«æœƒæŠŠé€™ç¨®\nã€æ¯å€‹äººå°ç’°å¢ƒåæ‡‰ä¸ä¸€æ¨£ã€çš„ç‹€æ³ï¼Œ\nå«åšã€é«”è³ªã€ã€‚", m: "ğŸ’¡" },
  { t: "ä¸æ˜¯èªªå“ªè£¡ä¸å¥½ï¼Œ\nåªæ˜¯æ¯å€‹äººæœ¬ä¾†å°±ä¸ä¸€æ¨£è€Œå·²ã€‚", m: "ğŸ˜Š" }
];

const W2_CLUES = {
  1: { t:"ç’°å¢ƒ", d:"æœ‰äº›äººå°å†·æ°£æˆ–æº«å·®æ¯”è¼ƒæ•æ„Ÿã€‚", r:"å°è€¶ï¼Œæˆ‘ä¸€é€²å†·æ°£æˆ¿çš„æ™‚å€™ï¼Œé¼»å­çœŸçš„æ¯”è¼ƒå®¹æ˜“ä¸èˆ’æœã€‚", i:"â„ï¸" },
  2: { t:"éæ•åŸ", d:"æœ‰äº›äººä¸€æ¥è§¸ç°å¡µæˆ–èŠ±ç²‰å°±æœƒæ‰“å™´åšã€‚", r:"æœ‰æ™‚å€™ä¸€ç¢°åˆ°ç°å¡µï¼Œæˆ‘å°±æœƒä¸€ç›´æƒ³æ‰“å™´åšã€‚", i:"ğŸŒ«ï¸" },
  3: { t:"ä¸­é†«è§€é»", d:"ä¸­é†«ç”¨ã€é«”è³ªã€å½¢å®¹æ¯å€‹äººåæ‡‰ä¸å¤ªä¸€æ¨£ã€‚", r:"åŸä¾†ä¸æ˜¯æ¯å€‹äººéƒ½ä¸€æ¨£ï¼Œåªæ˜¯åæ‡‰ä¸å¤ªä¸€æ¨£è€Œå·²ã€‚", i:"ğŸ§˜" }
};

let s = {};
try { s = JSON.parse(localStorage.getItem(DB_KEY)||"{}"); } catch(e) { s = {}; }
if(!s.hp) s = { hp:60, lv:1, exp:0, streak:0, w1s:false, w1d:false, w2s:false, w2d:false, nick:"" };

function save(){ localStorage.setItem(DB_KEY, JSON.stringify(s)); render(); }

let storyIdx = 0;
let curStory = null;
let cardIdx = 0;
let cluesFound = 0;
let selectedActions = new Set();
let w2Answers = { q1:"", q2:"", q3:"" };

function getW1Story() {
  const n = s.nick || "å°ä¸»äºº";
  return [
    { t: "å—¨ï¼å°ä¸»äººä½ å¥½ï¼Œæˆ‘æ˜¯é¼»é¼»ï¼(æ®æ‰‹)", m: "ğŸ‘‹", action: "greet" },
    { t: "è«‹å•å°ä¸»äººä½ å«ä»€éº¼åå­—å‘¢ï¼Ÿ", m: "ğŸ¤”", action: "askNick" },
    { t: `${n}ä½ å¥½ï¼\nå…¶å¯¦... æˆ‘å¸¸å¸¸å› ç‚ºã€éæ•ã€è¦ºå¾—å¥½é›£å—ã€‚\n`, m: "ğŸ˜£" },
    { t: "æœ€è¿‘æˆ‘å¸¸å¸¸ä¸€é€£ä¸²åœ°æ‰“å™´åšï¼Œ\né¼»å­è£¡é¢ä¹Ÿå¾ˆç™¢ï¼Œé‚„ä¸€ç›´æµæ¸…æ¸…çš„é¼»æ°´ã€‚\n", m: "ğŸ¤§" },
    { t: "æœ‰æ™‚å€™é¼»å­æœƒæ‚¶æ‚¶çš„ï¼Œ\nå‘¼å¸ä¸å¤ªé †ï¼Œæ—©ä¸Šèµ·åºŠæ™‚ç‰¹åˆ¥æ˜é¡¯ã€‚\n", m: "ğŸ˜" },
    { t: "ä¸åªæ˜¯é¼»å­ï¼Œçœ¼ç›å’Œå–‰åš¨æœ‰æ™‚ä¹Ÿæœƒç™¢ç™¢çš„ï¼Œ\nä¸€æ•´å¤©ä¸‹ä¾†åè€Œè¦ºå¾—å¾ˆç´¯ï¼Œä¹Ÿå¾ˆé›£å°ˆå¿ƒè®€æ›¸ã€‚\n", m: "ğŸ˜´" },
    { t: "æˆ‘ç™¼ç¾åªè¦é‡åˆ°ç°å¡µã€èŠ±ç²‰ï¼Œ\næˆ–å†·æ°£é–‹å¾ˆå¼·ã€æº«å·®è®Šå¤§çš„æ™‚å€™ï¼Œ\né€™äº›ä¸èˆ’æœå¥½åƒå°±æœƒæ›´æ˜é¡¯ã€‚\n", m: "ğŸŒ¡ï¸" },
    { t: "æˆ‘ä¹Ÿä¸ç¢ºå®šç‚ºä»€éº¼æœƒé€™æ¨£...\nä½ å¯ä»¥é™ªæˆ‘ç©å€‹å°éŠæˆ²ï¼Œ\nç¢ºèªä¸€ä¸‹æˆ‘å€‘ä»€éº¼æ™‚å€™æ¯”è¼ƒå®¹æ˜“ä¸èˆ’æœå—ï¼Ÿ\n", m: "ğŸ¥º" }
  ];
}

function render(){
  document.getElementById("hpVal").innerText = s.hp;
  document.getElementById("hpBar").style.width = s.hp + "%";
  document.getElementById("lvVal").innerText = s.lv;
  document.getElementById("lvBar").style.width = ((s.exp%50)*2) + "%";
  
  if(s.w1d) {
    document.getElementById("w2-lock").classList.add("hidden");
    document.getElementById("w1-game-ui").classList.add("hidden");
    document.getElementById("w1-action-ui").classList.add("hidden");
    document.getElementById("w1-done").classList.remove("hidden");
    if (!curStory) {
         // 2. æ–‡å­—ä¿®æ”¹ï¼šé€™è£¡æ›´æ–°äº†ï¼
         document.getElementById("mainBibi").innerText = "ğŸ˜Š";
         document.getElementById("bubbleText").innerText = "Week 1 é †åˆ©å®Œæˆï¼ğŸ‰\nè¬è¬ä½ é™ªæˆ‘ä¸€èµ·ç·´ç¿’ã€‚\n\næº–å‚™å¥½æˆ‘å€‘å°±è¦é€²å…¥ä¸‹é€±ï¼ˆWeek 2ï¼‰äº†å—ï¼Ÿ";
         document.getElementById("mood").innerText = "ğŸ˜Š";
    }
  } else {
    document.getElementById("w2-lock").classList.remove("hidden");
  }
  
  if(s.w2d) {
     document.getElementById("w2-content").innerHTML = "<div style='text-align:center;padding:30px;color:var(--good);font-weight:900'>Week 2 å·²å®Œæˆï¼</div>";
  }
}

function playStory(type){
  curStory = type;
  storyIdx = 0;
  const lockId = type==='w1' ? 'w1-story-lock' : 'w2-story-lock';
  document.getElementById(lockId).classList.remove("hidden");
  document.getElementById("btnNext").classList.remove("hidden");
  renderStoryFrame();
}

function renderStoryFrame(){
  const list = curStory==='w1' ? getW1Story() : W2_STORY;
  const item = list[storyIdx];
  if(curStory === 'w1' && item.action === 'askNick' && !s.nick) {
     document.getElementById("bubbleText").innerText = item.t;
     document.getElementById("mood").innerText = item.m;
     document.getElementById("btnNext").classList.add("hidden");
     document.getElementById("nickInputArea").classList.remove("hidden");
     return;
  }
  document.getElementById("bubbleText").innerText = item.t;
  document.getElementById("mood").innerText = item.m;
}

function confirmNick(){
  const input = document.getElementById("nickInput");
  const val = input.value.trim();
  if(!val) return alert("è«‹è¼¸å…¥ä¸€å€‹æš±ç¨±å–”ï¼");
  s.nick = val; save();
  document.getElementById("nickInputArea").classList.add("hidden");
  document.getElementById("btnNext").classList.remove("hidden");
  document.getElementById("bubbleText").innerText = `å¾ˆé«˜èˆˆèªè­˜ä½ ï¼Œ${val}ï¼`;
  document.getElementById("mood").innerText = "ğŸ˜Š";
}

function nextStory(){
  const list = curStory==='w1' ? getW1Story() : W2_STORY;
  storyIdx++;
  if(storyIdx >= list.length){
    document.getElementById("btnNext").classList.add("hidden");
    if(curStory === 'w1') {
       s.w1s = true; 
       document.getElementById("w1-story-lock").classList.add("hidden");
       document.getElementById("bubbleText").innerText = "æˆ‘å€‘é–‹å§‹å§ï¼è«‹æŒ‰ä¸‹é¢çš„ O æˆ– X ã€‚";
       renderCard();
    }
    if(curStory === 'w2') {
       s.w2s = true;
       document.getElementById("w2-story-lock").classList.add("hidden");
       document.getElementById("bubbleText").innerText = "è«‹å¹«æˆ‘æ‰¾å‡ºé€™ 3 å€‹ç·šç´¢ã€‚";
    }
    save();
    curStory = null;
    render();
  } else {
    renderStoryFrame();
  }
}

function renderCard(){
  const box = document.getElementById("card-stage");
  box.innerHTML = "";
  if(cardIdx >= W1_CARDS.length) { showActionSelect(); return; }
  const c = W1_CARDS[cardIdx];
  const div = document.createElement("div");
  div.className = "tinder-card";
  div.id = "active-card";
  div.innerHTML = `<div class="tc-icon">${c.i}</div><div class="tc-title">${c.t}</div><div class="tc-desc">${c.d}</div>`;
  box.appendChild(div);
}

function swipe(dir){
  const card = document.getElementById("active-card");
  if(!card) return;
  card.classList.add(dir==='left'?'swipe-left':'swipe-right');
  const msgs = dir==='right' ? ["æˆ‘ä¹Ÿæœƒè€¶ï¼","è¾›è‹¦äº†...","æˆ‘ä¹Ÿæ˜¯..."] : ["é‚£ä½ å¾ˆå¹¸é‹ï¼","çœŸå¥½ï½"];
  document.getElementById("bubbleText").innerText = msgs[Math.floor(Math.random()*msgs.length)];
  setTimeout(()=>{ cardIdx++; renderCard(); }, 400);
}

function showActionSelect() {
  document.getElementById("w1-game-ui").classList.add("hidden");
  document.getElementById("w1-action-ui").classList.remove("hidden");
  const grid = document.getElementById("action-stage");
  grid.innerHTML = W1_ACTIONS.map((a, i) => `
    <div class="action-card" id="act-${i}" onclick="toggleAction(${i})">
      <div class="action-emoji">${a.img}</div>
      <div class="action-text">${a.t}</div>
    </div>
  `).join("");
  document.getElementById("bubbleText").innerText = "é€™äº›éƒ½æ˜¯å¾ˆå¥½çš„å˜—è©¦ï¼Œä½ å¯ä»¥é¸ä¸€å€‹ï¼Œä¹Ÿå¯ä»¥é¸å¾ˆå¤šå€‹ï¼";
  document.getElementById("mood").innerText = "ğŸ˜Š";
}

function toggleAction(i) {
  const el = document.getElementById(`act-${i}`);
  if(selectedActions.has(i)) {
    selectedActions.delete(i);
    el.classList.remove("selected");
  } else {
    selectedActions.add(i);
    el.classList.add("selected");
  }
}

function submitActions() {
  if(selectedActions.size === 0) { alert("è«‹è‡³å°‘é¸ä¸€å€‹è©¦è©¦çœ‹å–”ï¼"); return; }
  const count = selectedActions.size;
  const choiceNames = Array.from(selectedActions).map(i => W1_ACTIONS[i].t).join(", ");
  
  let msg = "åªè¦é¡˜æ„å˜—è©¦ï¼Œå°é¼»å­éƒ½æœ‰å¹«åŠ©å–”ï¼";
  if(count >= 3) msg = "å“‡ï¼é¡˜æ„å˜—è©¦é€™éº¼å¤šï¼Œå¤ªæ£’äº†ï¼æˆ‘å€‘ä¸€èµ·åŠ æ²¹ï¼";
  else msg = "å¤ªå¥½äº†ï¼æˆ‘å€‘ä»Šå¤©å°±å¾é€™å€‹å°è¡Œå‹•é–‹å§‹è©¦è©¦çœ‹å§ï¼";
  document.getElementById("bubbleText").innerText = msg;
  document.getElementById("mood").innerText = "ğŸ˜";
  
  setTimeout(() => { finishW1(choiceNames); }, 2000);
}

function sendData(type, payload) {
  const finalData = Object.assign({}, { nick: s.nick, exp: s.exp }, payload);
  fetch(GOOGLE_SCRIPT_URL, {
    method: 'POST', mode: 'no-cors',
    body: JSON.stringify(finalData),
    headers: {'Content-Type': 'application/json'}
  }).then(() => console.log("Sent " + type)).catch(err => console.error(err));
}

function finishW1(choiceNames){
  if(s.w1d) return;
  s.w1d = true; s.exp+=20; s.hp+=10; save();
  sendData("W1", { action: choiceNames, w2_done: "No" });
  document.getElementById("w1-action-ui").classList.add("hidden");
  document.getElementById("w1-done").classList.remove("hidden");
  renderStats();
}

function findClue(id, el){
  if(el.classList.contains("found")) return;
  const c = W2_CLUES[id];
  document.getElementById("m-icon").innerText = c.i;
  document.getElementById("m-title").innerText = c.t;
  document.getElementById("m-desc").innerText = c.d;
  document.getElementById("m-reply").innerText = c.r;
  document.getElementById("modal").classList.add("show");
  document.getElementById("bubbleText").innerText = c.r;
  el.classList.add("found");
  cluesFound++;
  if(cluesFound >= 3){
    setTimeout(()=>{
       document.getElementById("w2-quiz-area").classList.remove("hidden");
       document.getElementById("w2-quiz-area").scrollIntoView({behavior:"smooth"});
       document.getElementById("bubbleText").innerText = "å¥½åƒçœŸçš„æœ‰ä¸åŒçš„å¯èƒ½ï¼Œæˆ‘æƒ³å†è½è½ä½ çš„æƒ³æ³•ã€‚";
    }, 1000);
  }
}

function answerQ(qid, ansText, hideId, showId){
   w2Answers[qid] = ansText;
   if(showId === 'DONE'){ finishW2(); } 
   else {
      document.getElementById(hideId).classList.add("hidden");
      document.getElementById(showId).classList.remove("hidden");
   }
}

function finishW2(){
  if(s.w2d) return;
  s.w2d = true; s.exp+=30; s.hp=100; s.lv++; save();
  sendData("W2", { w2_done: "Yes", q1_ans: w2Answers.q1, q2_ans: w2Answers.q2, q3_ans: w2Answers.q3 });
  alert("Week 2 å®Œæˆï¼");
  document.getElementById("bubbleText").innerText = "è¬è¬ä½ é™ªæˆ‘ä¸€èµ·æƒ³é€™äº›äº‹æƒ…ã€‚";
  render();
}

function switchTab(t){
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  document.querySelectorAll(".pane").forEach(x=>x.classList.remove("active"));
  if(t==='w1'){
    document.getElementById("t1").classList.add("active");
    document.getElementById("p-w1").classList.add("active");
    if(!s.w1s && !s.w1d) { playStory('w1'); renderCard(); } 
    else if (s.w1s && !s.w1d) { renderCard(); }
  } else if(t==='w2'){
    if(!s.w1d){ alert("è«‹å…ˆå®Œæˆ Week 1"); return switchTab('w1'); }
    document.getElementById("t2").classList.add("active");
    document.getElementById("p-w2").classList.add("active");
    if(!s.w2s && !s.w2d) playStory('w2');
  } else {
    document.getElementById("t3").classList.add("active");
    document.getElementById("p-leader").classList.add("active");
    renderLeader();
  }
}

// ä¿®æ­£ï¼šå‹•æ…‹æ®µä½é¡¯ç¤º (éŠ…ç‰Œ -> éŠ€ç‰Œ -> é‘½çŸ³)
function renderLeader(){
  const myName = s.nick || "æˆ‘";
  const myExp = s.exp;
  
  // åˆ¤æ–·æ®µä½
  let rankName = "ğŸ¥‰ éŠ…ç‰Œæ–°ç§€";
  let rankIcon = "ğŸ¥‰";
  let rankColor = "#cd7f32"; // éŠ…è‰²
  
  if(myExp >= 50) { 
    rankName = "ğŸ¥ˆ éŠ€ç‰Œé«˜æ‰‹"; 
    rankIcon = "ğŸ¥ˆ";
    rankColor = "#7f8c8d"; // éŠ€ç°è‰²
  }
  if(myExp >= 100) { 
    rankName = "ğŸ’ é‘½çŸ³å¤§å¸«"; 
    rankIcon = "ğŸ’";
    rankColor = "#3498db"; // é‘½çŸ³è— (Duolingo é¢¨æ ¼)
  }
  
  document.getElementById("badgeIcon").innerText = rankIcon;
  document.getElementById("badgeName").innerText = rankName;
  document.getElementById("badgeName").style.color = rankColor;

  // å»ºç«‹è™›æ“¬åå–®
  const fakeUsers = [
    { n: "å°å‚‘", e: myExp + 15, a: "ğŸ‘¦" },
    { n: "é˜¿è±ª", e: myExp + 5, a: "ğŸ˜" },
    { n: "Yumi", e: Math.max(0, myExp - 10), a: "ğŸ‘§" },
    { n: "å°ç¾", e: Math.max(0, myExp - 25), a: "ğŸ‘±â€â™€ï¸" }
  ];
  
  const myList = [...fakeUsers, { n: myName, e: myExp, a: "ğŸ˜Š", me: true }];
  myList.sort((a,b) => b.e - a.e);
  
  document.getElementById("leaderList").innerHTML = myList.map((u, i) => `
    <div class="leader-item ${u.me ? 'me' : ''}">
      <div class="rank-num">${i+1}</div>
      <div class="user-info">
        <div class="user-avatar">${u.a}</div>
        <div class="user-name">${u.n}</div>
      </div>
      <div class="user-exp">${u.e} EXP</div>
    </div>
  `).join("");
}

function closeModal(){ document.getElementById("modal").classList.remove("show"); }
function pokeBibi(){ if(curStory) return; document.getElementById("bubbleText").innerText = "ä»Šå¤©ä¹Ÿè¦åŠ æ²¹å–”ï¼"; }
function setNick(){ const n=prompt("ä¿®æ”¹æš±ç¨±", s.nick); if(n){s.nick=n;save();} }
function resetAll(){ localStorage.removeItem(DB_KEY); location.reload(); }

render();
switchTab('w1');
</script>
</body>
</html>
